name: Deploy to AWS Lambda (Serverless)

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_deploy:
        description: "Force deployment even if tests fail"
        required: false
        default: "false"

env:
  AWS_REGION: us-east-1
  NODE_VERSION: "18"
  GO_VERSION: "1.23"

jobs:
  lint:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install golangci-lint
        run: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest

      - name: Run go fmt
        run: |
          fmtres=$(go fmt ./...)
          if [ -n "$fmtres" ]; then
            echo "Code is not formatted. Run 'go fmt ./...' locally." && exit 1
          fi

      - name: Run go vet
        run: go vet ./...

      - name: Run golangci-lint
        run: golangci-lint run ./... --timeout=5m

  deploy:
    # needs: lint
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set environment variables
        run: |
          echo "Current branch: ${{ github.ref }}"
          echo "Branch name: ${{ github.ref_name }}"

          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
            echo "STAGE=prod" >> $GITHUB_ENV
            echo "SECRET_SUFFIX=LUUpbF" >> $GITHUB_ENV
            echo "DB_HOST=consistency-prod-db.cs5c86m8c7jh.us-east-1.rds.amazonaws.com" >> $GITHUB_ENV
            echo "DOMAIN=api.consistency-production.shubhams.dev" >> $GITHUB_ENV
            echo "CERT_ARN=arn:aws:acm:us-east-1:649024131095:certificate/2c8a7a6d-ae93-4dd1-8f5e-679864789461" >> $GITHUB_ENV
            echo "Deploying to PRODUCTION"
          else
            echo "Unknown branch: ${{ github.ref_name }}"
            echo "Only main branch is supported for this cost-optimized setup"
            exit 1
          fi

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install Serverless Framework
        run: |
          npm install -g serverless@3
          npm init -y

      - name: Get database credentials from Secrets Manager
        run: |
          echo "Retrieving database credentials from AWS Secrets Manager..."

          # Get DB user - using the simple name we created
          echo "Getting database user..."
          DB_USER=$(aws secretsmanager get-secret-value \
            --secret-id "consistency-db-user" \
            --query SecretString \
            --output text \
            --region ${{ env.AWS_REGION }})

          # Get DB password - using the simple name we created
          echo "Getting database password..."
          DB_PASSWORD=$(aws secretsmanager get-secret-value \
            --secret-id "consistency-db-password" \
            --query SecretString \
            --output text \
            --region ${{ env.AWS_REGION }})

          # Validate we got the secrets
          if [ -z "$DB_USER" ] || [ -z "$DB_PASSWORD" ]; then
            echo "âŒ Failed to retrieve database credentials"
            echo "DB_USER length: ${#DB_USER}"
            echo "DB_PASSWORD length: ${#DB_PASSWORD}"
            exit 1
          fi

          # Check if password is still placeholder
          if [ "$DB_PASSWORD" = "PLACEHOLDER_UPDATE_ME" ]; then
            echo "âŒ Database password is still set to placeholder!"
            echo "Please update the secret 'consistency-db-password' with your actual database password:"
            echo "aws secretsmanager update-secret --secret-id consistency-db-password --secret-string 'YOUR_ACTUAL_PASSWORD' --region us-east-1"
            exit 1
          fi

          echo "âœ… Successfully retrieved database credentials"
          echo "DB_USER=$DB_USER" >> $GITHUB_ENV
          echo "DB_PASSWORD=$DB_PASSWORD" >> $GITHUB_ENV

      - name: Build Lambda function
        run: |
          echo "Building Go application for AWS Lambda..."
          GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -ldflags="-s -w" -o bootstrap cmd/lambda/main.go
          chmod +x bootstrap
          echo "âœ… Lambda function built successfully"

      - name: Create serverless config
        run: |
          echo "Creating serverless.yml configuration..."
          TIMESTAMP=$(date +%s)
          SERVICE_NAME="consistency-lambda-${TIMESTAMP}"
          echo "Using service name: $SERVICE_NAME"

          cat > serverless.yml << EOF
          service: $SERVICE_NAME

          provider:
            name: aws
            runtime: provided.al2
            region: ${{ env.AWS_REGION }}
            memorySize: 128
            timeout: 30
            environment:
              ENV: ${{ env.ENVIRONMENT }}
              LOG_LEVEL: error
              DB_HOST: ${{ env.DB_HOST }}
              DB_PORT: "5432"
              DB_NAME: consistency_service
              DB_SSL_MODE: disable
              DB_USER: ${{ env.DB_USER }}
              DB_PASSWORD: ${{ env.DB_PASSWORD }}

          functions:
            api:
              handler: bootstrap
              events:
                - httpApi:
                    path: /{proxy+}
                    method: any
                - httpApi:
                    path: /
                    method: any

          package:
            individually: true
            patterns:
              - "!./**"
              - "./bootstrap"
          EOF
          echo "âœ… Serverless configuration created with service name: $SERVICE_NAME"

      - name: Deploy to AWS Lambda
        run: |
          echo "ğŸš€ Deploying to AWS Lambda..."
          serverless deploy --stage prod --verbose

          echo ""
          echo "âœ… Serverless deployment complete!"
          echo "ğŸ“Š Monthly cost: ~$8 (down from $120+ with ECS)"
          echo "ğŸŒ API endpoint: https://${{ env.DOMAIN }}"
          echo "ğŸ’° Annual savings: $1,400+"

      - name: Test deployment
        run: |
          echo "ğŸ§ª Testing deployment..."
          sleep 30

          echo "Getting API Gateway URL..."
          API_URL=$(aws apigateway get-rest-apis --region ${{ env.AWS_REGION }} --query 'items[?name==`$SERVICE_NAME`].id' --output text 2>/dev/null || echo "")

          if [ -z "$API_URL" ]; then
            echo "API Gateway URL not found via REST API, checking CloudFormation outputs..."
            STACK_NAME=$(aws cloudformation list-stacks --region ${{ env.AWS_REGION }} --query 'StackSummaries[?starts_with(StackName, `consistency-lambda-`) && StackStatus==`CREATE_COMPLETE`].StackName' --output text | head -1)
            API_URL=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --region ${{ env.AWS_REGION }} --query 'Stacks[0].Outputs[?OutputKey==`HttpApiUrl`].OutputValue' --output text 2>/dev/null || echo "")
          fi

          if [ -n "$API_URL" ]; then
            echo "Testing health endpoint at: $API_URL"
            if curl -f -s "$API_URL/health" > /dev/null; then
              echo "âœ… Health check passed!"
              echo "ğŸ‰ Migration to serverless Lambda complete!"
              echo ""
              echo "ğŸ”— Your API is now live at: $API_URL"
              echo "ğŸ“Š Cost optimized: ~$8/month (92% savings!)"
              echo ""
              echo "Next steps:"
              echo "1. Update your frontend to use the new API URL"
              echo "2. Set up custom domain if needed"
            else
              echo "âŒ Health check failed!"
              echo "API URL: $API_URL"
              exit 1
            fi
          else
            echo "âš ï¸ Could not determine API Gateway URL"
            echo "Deployment may have succeeded, but unable to test automatically"
            echo "Check the AWS Console for your Lambda function and API Gateway"
          fi
